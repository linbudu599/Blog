---
title: "ã€outdatedã€‘Express-GraphQL æºç è§£è¯»"
date: 2020-11-19
slug: "/express-graphql"
---

## å‰è¨€

æœ€è¿‘åœ¨â€œè®¤çœŸâ€çš„å­¦ä¹  GraphQLï¼Œæ„Ÿè§‰è‡ªå·±ä¹‹å‰å­¦çš„è¿˜æ˜¯å¤ªæµ…äº†ï¼Œå¾ˆå¤šç°åœ¨çœ‹æ¥æ˜¯æ ¸å¿ƒç‰¹æ€§çš„å½“æ—¶éƒ½ä¸çŸ¥é“...ï¼Œæ¯”å¦‚ Subscription æ“ä½œï¼Œè¿˜æœ‰ TypeGraphQL çš„å¼ºå¤§èƒ½åŠ›ï¼ˆç­‰æˆ‘å†å¼ºä¸€ç‚¹ä¸€å®šè¦ç»™è¿™ä¸ªé¡¹ç›®åšè´¡çŒ®ï¼ç¿»è¯‘æ–‡æ¡£ä¹Ÿè¡Œï¼ï¼‰ç­‰ç­‰ã€‚

ä¼šæƒ³ç€çœ‹è¿™ä¸œè¥¿æºç æ˜¯å› ä¸ºç›®å‰ä¼¼ä¹æˆ‘èƒ½çœ‹æ‡‚çš„å°±è¿™ä¸ªï¼Œå…¶ä»–æ— è®ºæ˜¯ Apollo-Server è¿˜æ˜¯ TypeGraphQL éƒ½æ˜¯å¤§é¡¹ç›®ï¼Œæ›´åˆ«è¯´åŸç”Ÿ GraphQLJS äº†ï¼ŒçœŸçš„æ˜¯ä¸€ä¸ªå·¨å·¨å·¨å·¨å¤§çš„é¡¹ç›®ã€‚

ç°åœ¨è¿˜åœ¨åšä¸¤ä»¶ GraphQL ç›¸å…³çš„äº‹æƒ…ï¼Œ[GraphQL-Explorer](https://github.com/linbudu599/GraphQL-Explorer) å’Œ [GraphQL-Lessons](https://github.com/linbudu599/GraphQL-Article-Examples)ï¼Œå‰è€…ç†Ÿæ‚‰å„ä¸ªç›¸å…³ç”Ÿæ€ï¼ˆApolloã€TypeGraphQLã€TypeORMã€TypeStack ç­‰ç­‰ï¼‰çš„èƒ½åŠ›ä½¿ç”¨ï¼Œåè€…åœ¨å‡†å¤‡ç³»åˆ—æ–‡ç« çš„åŒæ—¶ä¹ŸæŠŠåŸºç¡€æ‰“æ‰å®ã€‚

ä¸è¿‡è¯è¯´å›æ¥ï¼ŒGraphQL çš„å­¦ä¹ æˆæœ¬è¿™ä¹ˆä½ï¼ŒçœŸçš„éœ€è¦ç³»åˆ—æ•™ç¨‹å—...

## fieldResolver

ä¸ TypeGraphQL ä¸­çš„æ€è·¯ç±»ä¼¼ï¼Œä½†å®é™…æ•ˆæœä¸åŒã€‚å¦‚æœæŒ‡å®šäº† fieldResolverï¼Œå°±ç›¸å½“äºä½ è¦è‡ªå·±å¤„ç† resolver å’Œ field çš„å­—æ®µå¯¹åº”å…³ç³»äº†ï¼Œè¿˜æœ‰è”åˆç±»å‹ã€åµŒå¥—ç±»å‹çš„æƒ…å†µä¹Ÿéœ€è¦è‡ªå·±å¤„ç†ã€‚å”¯ä¸€çš„ç”¨å¤„æ˜¯ä¸€ä¸ªå…œåº•ä½œç”¨çš„ resolverï¼Œä¹Ÿå°±æ˜¯ä½ æŸ¥è¯¢çš„å­—æ®µæ²¡æœ‰å¯¹åº”çš„ resolverï¼ˆä½†ä»ç„¶å¿…é¡»åœ¨ schema ä¸­å®šä¹‰ï¼‰ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—åœ¨ä½¿ç”¨ Express-GraphQL çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰å¯¹å…œåº• resolver çš„å¼ºçƒˆéœ€æ±‚ï¼Œä¸è¦æŒ‡å®šè¿™ä¸ªå‡½æ•°ï¼Œä¸ç„¶çœŸçš„å¤ªå¤ªå¤ªéº»çƒ¦äº†ã€‚

TypeGraphQL ä¸­çš„`@FieldResolver`æ˜¯å’Œ`@Query` `@Mutation`å¹³çº§çš„æ“ä½œï¼Œé€šå¸¸æ˜¯æŸä¸ªéœ€è¦é¢å¤–æ“ä½œï¼ˆè®¡ç®—/è¯·æ±‚æ•°æ®ï¼‰çš„å­—æ®µï¼Œé€šå¸¸ä¼šå’Œ`@Root`ä¸€èµ·ä½¿ç”¨ï¼Œåè€…ç”¨æ¥æ³¨å…¥æ•´ä¸ªæŸ¥è¯¢å¯¹è±¡ï¼Œæ¯”å¦‚ï¼š

```typescript
class UserResolver {
  @FieldResolver()
  async spAgeField(
    @Root() user: User,
    @Arg("param", { nullable: true }) param?: number
  ): Promise<number> {
    // ... do sth addtional here
    return user.age;
  }
}
```

> ç®€å•çš„æƒ…å†µä¹Ÿå¯ä»¥ç›´æ¥å®šä¹‰åœ¨`ObjectType`é‡Œé¢ï¼Œè§[field-resolver](https://typegraphql.com/docs/resolvers.html#field-resolvers)

ä½†åœ¨è¿™é‡Œçš„ fieldResolver å°±æœ‰ç‚¹éº»çƒ¦äº†ï¼š

```typescript
{
  // ...
  fieldResolver: (src, args, context, info) => {
    const isUnionType = ['A', 'B'].includes(info.path.typename);
    const isNestedType = ['Nested', 'NestedAgain'].includes(
      info.path.typename,
    );
    if (info.fieldName in src && !isUnionType && !isNestedType) {
      return src[info.fieldName]();
    } else if (isUnionType) {
      return info.path.typename;
    } else if (isNestedType) {
      return src[info.fieldName];
    }
    return 'DEFAULT_RESOLVER_RESULT';
  },
}
```

- `src`å³ä¸ºä¼ å…¥çš„ rootValue å€¼ï¼ˆä¹Ÿå°±æ˜¯ resolver ç»„ï¼‰

- è”åˆç±»å‹ï¼ˆ`Union Type`ï¼‰ä¼šè¢«å¤„ç†ä¸¤æ¬¡ï¼Œé¦–æ¬¡ src å€¼ä¸º rootValueï¼Œç¬¬äºŒæ¬¡ä¸ºæœ¬æ¬¡è”åˆç±»å‹å­ç±»å‹çš„å€¼ï¼Œæ³¨æ„ï¼Œ`typeResolver`ä¼šåœ¨ä¸­é—´è¢«è°ƒç”¨ï¼å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„å¤„ç†æ˜¯åˆ¤æ–­ä¸ºè”åˆç±»å‹çš„æƒ…å†µï¼Œå°±ç›´æ¥è¿”å›è¿™ä¸ªå€¼ï¼ˆä¹Ÿå°±æ˜¯`info.path.typename`ï¼‰ã€‚

  æ¯”å¦‚é¦–æ¬¡æ˜¯:

  ```js
  {
    hello: [Function: hello],
    // è”åˆç±»å‹
    guess: [Function: guess],
    nest: [Function: nest]
  }
  ```

  ç¬¬äºŒæ¬¡å°±æ˜¯ï¼š`{ fieldB: 'bbb' }`

- åµŒå¥—ç±»å‹ç±»ä¼¼ï¼Œä¹Ÿä¼šè¢«å¤„ç†å¤šæ¬¡ï¼ˆæ¬¡æ•°å’Œå±‚çº§æœ‰å…³ï¼‰ï¼Œå¹¶ä¸”åœ¨æœ€åä¸€çº§æ—¶`src`å°±åŒ…æ‹¬äº†å€¼ï¼Œç›´æ¥è¿”å›å³å¯ã€‚

- åµŒå¥—ç±»å‹å’Œè”åˆç±»å‹è¿™é‡Œéƒ½éœ€è¦æ ¹æ®`info.path.typename`è¿›è¡Œåˆ¤æ–­ï¼Œç¡®å®å¾ˆä¸ä¼˜é›…ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨è¿™ä¸ªã€‚

## typeResolver

å’Œ Apollo ä¸­ä¸€æ ·ï¼Œä½† Apollo ä¸­æ˜¯å’Œ Query å’Œ Mutation åŒçº§çš„ï¼Œæ”¾åœ¨ resolvers é€‰é¡¹ä¸­ã€‚

ä½¿ç”¨æ–¹å¼ä¸€æ ·ï¼Œæ ¹æ® resolver è¿”å›çš„å€¼åˆ¤æ–­æ˜¯å±äºå“ªä¸ªç±»å‹ï¼ˆé€šå¸¸æ˜¯é€šè¿‡åŒ…å«çš„å­—æ®µæ¥åˆ¤æ–­ï¼‰ã€‚

```typescript
{
  typeResolver: (value, ctx, info, absType) => {
      return value.fieldA ? 'A' : 'B';
    },
}
```

- `absType`ï¼Œå³`AbstractType`ï¼Œæœ¬æ¬¡å¾…è§£æçš„è”åˆç±»å‹ã€‚

## æºç å…¨æµç¨‹è§£æ

åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š

- æ•´ä½“æ¶æ„
- å‚æ•°è§£æ
- æ‰§è¡Œ
- GraphiQL å“åº”

### æ•´ä½“æ¶æ„

å…ˆçœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆè¢«ä½¿ç”¨çš„ï¼š

```typescript
import express from "express";
import { buildSchema } from "graphql";

import { graphqlHTTP } from "../src";

const schema = buildSchema(`
  type Query {
    hello: String
  }
`);

const rootValue = {
  hello: () => "Hello world!",
};

const app = express();

app.use(
  "/graphql",
  graphqlHTTP({
    schema,
    rootValue,
    graphiql: true,
  })
);
app.listen(4000);
```

å¾ˆæ˜æ˜¾ï¼Œ`graphqlHTTP()`æ–¹æ³•è¿”å›ä¸€ä¸ª Express ä¸­é—´ä»¶å‡½æ•°(`(req, res, next) => {}`è¿™æ ·)ï¼Œå¹¶ä¸”åªåœ¨`/graphql`ä¸‹ç”Ÿæ•ˆã€‚

å®ƒæ¥æ”¶`schema`ã€`rootValue`ã€`graphiql`å‚æ•°ï¼Œè¿™é‡Œåªæœ‰`rootValue`å¯èƒ½ä¼šè®©ä½ æ„Ÿåˆ°å›°æƒ‘ï¼Œå®é™…ä¸Šä½ å°±æŠŠå®ƒç†è§£ä¸º`resolvers`ï¼ˆApollo ä¸­çš„é‚£æ ·ï¼‰å°±å¥½äº†ã€‚

é¡ºä¾¿æŠŠå®ƒèƒ½æ¥å—çš„å‚æ•°éƒ½çœ‹çœ‹:

- schema
- context: åœ¨æ‰€æœ‰ resolverï¼ˆåŒ…æ‹¬ typeResolver å’Œ fieldResolverï¼‰ã€extensions çš„å‡½æ•°ä¸­å…±äº«çš„ä¸Šä¸‹æ–‡ã€‚**ä¸è¦åœ¨ä»»æ„ä¸€ä¸ªåœ°æ–¹å»ä¿®æ”¹å®ƒ**
- rootValue: Apollo ä¸­çš„ rootValue å’Œè¿™é‡Œçš„å®Œå…¨ä¸ä¸€æ ·ã€‚Apollo ä¸­æ­¤å‚æ•°ä¼šè¢«ä½œä¸º resolvers é“¾çš„é¦–ä¸ªæˆå‘˜çš„ parent å‚æ•°ï¼ˆåç»­æˆå‘˜çš„ parent å‚æ•°åˆ™æ˜¯ä¸Šä¸€çº§çš„ resolver è¿”å›å€¼ï¼‰ã€‚
  > rootValue æ˜¯`{ [key:string]: Function }`çš„å½¢å¼ï¼Œå®ƒçš„å‡½æ•°åªæœ‰ä¸‰ä¸ªå‚æ•°ï¼ˆå°‘äº† parentï¼‰ï¼š`args` `context` `info`
- pretty: æ˜¯å¦æ ¼å¼åŒ–è¾“å‡º
- validationRules customValidateFnï¼Œschema é€»è¾‘éªŒè¯ç›¸å…³
- customExecuteFn: è¿™ä¸ªæœ‰ä¸¶ ğŸ‚ï¼Œç›´æ¥è¦†ç›–åŸç”Ÿ GraphQL çš„`execute`æ–¹æ³•
- customFormatErrorFn formatError: é”™è¯¯å¤„ç†ç›¸å…³
- customParseFn: è¦†ç›– GraphQL çš„ SDL è§£æå‡½æ•°
- extensions: æ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯åŸç”Ÿ`extensions`
- graphiql: æ˜¯å¦å¼€å¯ GraphiQL è°ƒè¯•é¢æ¿ï¼Œæ²¡æœ‰ Apollo çš„ playground å¥½ç”¨
  > Gatsby çš„ GraphiQL æ˜¯åœ¨åŸç”ŸåŸºç¡€ä¸Šå¢å¼ºçš„ï¼Œæä¾›äº†ç‚¹å‡»å­—æ®µæ¥æ·»åŠ åˆ°æŸ¥è¯¢è¯­å¥çš„èƒ½åŠ›
- fieldResolver ä¸ typeResolver è§ä¸Šé¢çš„

å…¥å£æ–¹æ³•:

> æ¥ä¸‹æ¥çš„é€»è¾‘å¤§éƒ¨åˆ†éƒ½åœ¨è¿™ä¸ªæ–¹æ³•å†…

```typescript
export function graphqlHTTP(options: Options): Middleware {
  return async function graphqlMiddleware(
    request: Request,
    response: Response
  ): Promise<void> {};
}
```

é¦–å…ˆé…ç½®å‚æ•°ï¼š

```typescript
let params: GraphQLParams | undefined;
let showGraphiQL = false;
let graphiqlOptions;
// è¿™ä¸€æ–¹æ³•æ¥è‡ªäºåŸç”ŸGraphQLå¯¼å‡º
let formatErrorFn = formatError;
let pretty = false;
let result: ExecutionResult;
```

è§£æå‚æ•°ï¼š`getGraphQLParams`æ–¹æ³•

ä¼šæŠŠæ•´ä¸ªè¯·æ±‚ä½“å¡è¿›æ¥è§£æã€æå–ã€æ ¼å¼åŒ–ä¿¡æ¯ï¼Œæœ€åè¿”å›èƒ½äº¤ç»™ GraphQLJS å¤„ç†çš„å‚æ•°æ ¼å¼ã€‚
è¿™é‡Œå°±æ˜¯æ™®é€šçš„è¯·æ±‚å¤„ç†é€»è¾‘

```typescript
params = await getGraphQLParams(request);

export async function getGraphQLParams(
  request: Request
): Promise<GraphQLParams> {
  const urlData = new URLSearchParams(request.url.split("?")[1]);
  const bodyData = await parseBody(request);

  // æŸ¥è¯¢è¯­å¥
  let query = urlData.get("query") ?? (bodyData.query as string | null);
  if (typeof query !== "string") {
    query = null;
  }

  // å˜é‡
  let variables = (urlData.get("variables") ?? bodyData.variables) as {
    readonly [name: string]: unknown;
  } | null;
  if (typeof variables === "string") {
    try {
      variables = JSON.parse(variables);
    } catch {
      throw httpError(400, "Variables are invalid JSON.");
    }
  } else if (typeof variables !== "object") {
    variables = null;
  }

  // æ“ä½œåç§°
  let operationName =
    urlData.get("operationName") ?? (bodyData.operationName as string | null);
  if (typeof operationName !== "string") {
    operationName = null;
  }

  // åŸå§‹ä¿¡æ¯
  const raw = urlData.get("raw") != null || bodyData.raw !== undefined;

  return { query, variables, operationName, raw };
}
```

è¯·æ±‚è§£æï¼š`parseBody`

```typescript
export async function parseBody(
  req: Request
): Promise<{ [param: string]: unknown }> {
  const { body } = req;
  //  contentType.parse(req.headers['content-type'])çš„ç®€å†™
  // è§£æç»“æœåŒ…æ‹¬typeä¸parameters å¦‚
  // 'image/svg+xml; charset=utf-8' -> { type: 'image/svg+xml', parameters: {charset: 'utf-8'} }
  const typeInfo = contentType.parse(req);

  // application/graphqlä¼¼ä¹ä¸æ˜¯å¸¸ç”¨çš„MIMEç±»å‹ å®˜æ–¹æ–‡æ¡£ä¹ŸæŠŠè¿™ä¸ªè¯´æ˜ç§»é™¤äº†
  // åº”å½“è¢«appilication/jsonæ›¿ä»£
  if (typeof body === "string" && typeInfo.type === "application/graphql") {
    return { query: body };
  }

  // è·å–åŸå§‹bodyå†…å®¹ï¼Œå¯¹ä¸åŒçš„è¯·æ±‚å¤´ä½¿ç”¨ä¸åŒçš„è§£ææ–¹å¼
  const rawBody = await readBody(req, typeInfo);
  switch (typeInfo.type) {
    case "application/graphql":
      return { query: rawBody };
    case "application/json":
      if (jsonObjRegex.test(rawBody)) {
        try {
          return JSON.parse(rawBody);
        } catch {
          // Do nothing
        }
      }
      // status error properties
      throw httpError(400, "POST body sent invalid JSON.");
    case "application/x-www-form-urlencoded":
      // parse(str) foo=bar&abc=xyz&abc=123 ->
      // {
      //   foo: 'bar',
      //   abc: ['xyz', '123']
      // }
      return querystring.parse(rawBody);
  }

  return {};
}
```

è·å–åŸå§‹ body å†…å®¹ï¼šreadBody

```typescript
async function readBody(
  req: Request,
  // {type:"xxx", parameters:"xxx"}
  typeInfo: ParsedMediaType
): Promise<string> {
  // è·å–mimeçš„chartsetå±æ€§
  const charset = typeInfo.parameters.charset?.toLowerCase() ?? "utf-8";

  // Get content-encoding (e.g. gzip)
  // å†…å®¹ç¼–ç æ ¼å¼ gzip deflate identity(æ²¡æœ‰å¯¹å®ä½“è¿›è¡Œç¼–ç ) ...
  // æœåŠ¡å™¨ä¼šä¾æ®æ­¤ä¿¡æ¯è¿›è¡Œè§£å‹
  // æœåŠ¡ç«¯è¿”å›æœªå‹ç¼©çš„æ­£æ–‡æ—¶ ä¸å…è®¸è¿”å›æ­¤å­—æ®µ
  const contentEncoding = req.headers["content-encoding"];

  const encoding =
    typeof contentEncoding === "string"
      ? contentEncoding.toLowerCase()
      : // è¿™ç§æƒ…å†µæ˜¯æ²¡æœ‰å¸¦ä¸Šcontent-encondingå¤´ ä¹Ÿå°±æ˜¯æ²¡æœ‰å¤„ç†
        "identity";

  // æ­£æ–‡æœªå‹ç¼©æ—¶ç›´æ¥è¯»å–æ­£æ–‡é•¿åº¦
  const length = encoding === "identity" ? req.headers["content-length"] : null;
  const limit = 100 * 1024; // 100kb

  // è¿™ä¸ªæ–¹æ³•æŠŠè¯·æ±‚è§£å‹åå¡åˆ°æµé‡Œ
  const stream = decompressed(req, encoding);

  // å†ä»æµé‡Œè¯»å‡ºæ¥è¯·æ±‚ä½“å†…å®¹
  try {
    // charset é»˜è®¤ä¸ºutf-8 ä½¿ç”¨å¯¹åº”çš„content-encodingè§£ç 
    // length æµçš„é•¿åº¦ ç›®æ ‡é•¿åº¦æ²¡æœ‰è¾¾åˆ°æ—¶ä¼šæŠ¥400é”™è¯¯ é»˜è®¤ä¸ºnull åœ¨ç¼–ç identityæ—¶ä¸ºcontent-lengthçš„å€¼
    // limit 100kb bodyçš„å­—èŠ‚æ•°é™å®š å¦‚æœbodyè¶…å‡ºè¿™ä¸ªå¤§å° ä¼šæŠ¥413é”™è¯¯
    return await getBody(stream, { encoding: charset, length, limit });
  } catch (rawError) {
    const error = httpError(
      400,
      rawError instanceof Error ? rawError : String(rawError)
    );

    error.message =
      error.type === "encoding.unsupported"
        ? `Unsupported charset "${charset.toUpperCase()}".`
        : `Invalid body: ${error.message}.`;
    throw error;
  }
}

// è§£å‹æµ
function decompressed(
  req: Request,
  encoding: string
): Request | Inflate | Gunzip {
  switch (encoding) {
    case "identity":
      return req;
    case "deflate":
      // readable.pipe(writable)
      return req.pipe(zlib.createInflate());
    case "gzip":
      return req.pipe(zlib.createGunzip());
  }
  throw httpError(415, `Unsupported content-encoding "${encoding}".`);
}
```

åˆ°è¿™é‡Œå·²ç» get äº†æœ¬æ¬¡è¯·æ±‚çš„å‚æ•°ï¼Œå¹¶è½¬åŒ–ä¸ºäº† GraphQL èƒ½å¤Ÿè§£æçš„æ ¼å¼ã€‚

è§£æé…ç½®ï¼š

```typescript
// æœ‰å¯èƒ½æ¥æ”¶Promiseç±»å‹æˆ–è¿”å›Promiseç±»å‹çš„å‚æ•° è¿™é‡Œå°±æ˜¯ç®€å•åœ°ç­‰å¾…å…¶æ‰§è¡Œå®Œæ¯•
// æ¯”å¦‚TypeGraphQLçš„buildSchemé»˜è®¤å°±æ˜¯å¼‚æ­¥çš„
const optionsData: OptionsData = await resolveOptions(params);

const schema = optionsData.schema;
const rootValue = optionsData.rootValue;
const validationRules = optionsData.validationRules ?? [];
// ... ç±»ä¼¼çš„é€»è¾‘
```

åˆ¤æ–­è¯·æ±‚æ–¹æ³•ï¼šåªæ”¯æŒ GET å’Œ POST æ–¹æ³•ï¼š

```typescript
if (request.method !== "GET" && request.method !== "POST") {
  throw httpError(405, "GraphQL only supports GET and POST requests.", {
    headers: { Allow: "GET, POST" },
  });
}
```

åˆ¤æ–­ä¸‹æ˜¯å¦è¦è¿”å› GraphiQLï¼ˆæˆ–è€…è¯´é€šè¿‡ GraphiQL è¿›è¡Œæ•°æ®è¿”å›ï¼‰ è¿™é‡Œåœ¨åé¢çš„ä¸“é—¨éƒ¨åˆ†è®²

```typescript
const { query, variables, operationName } = params;

showGraphiQL = canDisplayGraphiQL(request, params) && graphiql !== false;
if (typeof graphiql !== "boolean") {
  graphiqlOptions = graphiql;
}

if (query == null) {
  if (showGraphiQL) {
    return respondWithGraphiQL(response, graphiqlOptions);
  }
  throw httpError(400, "Must provide query string.");
}
```

éªŒè¯ schema æ˜¯å¦åˆæ³•ã€è§£æ ASTã€éªŒè¯ AST æ˜¯å¦åˆæ³•ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºä»£ç äº†ã€‚

> è‡ªå®šä¹‰è§„åˆ™ä¼šå’Œå†…ç½®è§„åˆ™è¿›è¡Œåˆå¹¶

å¯¹äºè¯·æ±‚æ–¹æ³•ä¸º GET çš„æƒ…å†µå†è¿›è¡Œä¸€æ¬¡å¤„ç†

> åªæœ‰ query æ“ä½œå¯ä»¥é€šè¿‡ GET æ‰§è¡Œï¼Œä½†é€šå¸¸ä¹Ÿä¸ä¼šä½¿ç”¨

è¿™é‡Œçš„é€»è¾‘ä¸»è¦æ˜¯æ£€æµ‹æ“ä½œæ˜¯å¦æ˜¯é™¤äº† query ä»¥å¤–çš„ç±»å‹ï¼Œå¦‚æœä¸æ˜¯ queryï¼Œå°±ç›´æ¥æŠŠ params å¡è¿› GraphiQL
è¿”å›ï¼Œç»™è¯·æ±‚è€…è‡ªå·±æ‰§è¡Œï¼ˆåœ¨å…¶ä¸­æ‰§è¡Œæ“ä½œéƒ½æ˜¯ä»¥ POST è¯·æ±‚ï¼‰ã€‚

å¦‚æœä¸èƒ½å±•ç¤º GraphiQLï¼Œå°±æŠ¥é”™

```typescript
// Only query operations are allowed on GET requests.
// GETè¯·æ±‚åªèƒ½èµ°queryæ“ä½œï¼Œç±»ä¼¼RESTFulè§„èŒƒ
if (request.method === "GET") {
  // Determine if this GET request will perform a non-query.
  const operationAST = getOperationAST(documentAST, operationName);
  if (operationAST && operationAST.operation !== "query") {
    // If GraphiQL can be shown, do not perform this query, but
    // provide it to GraphiQL so that the requester may perform it
    // themselves if desired.
    // PUZZLE: å¦‚æœæ­¤æ—¶å¼€å¯äº†GraphiQLé€‰é¡¹ é‚£ä¹ˆå°±æŠŠå†…å®¹è¿”å›ç»™GraphiQL ä¾›è¯·æ±‚è€…è‡ªå·±æ‰§è¡Œ
    if (showGraphiQL) {
      return respondWithGraphiQL(response, graphiqlOptions, params);
    }

    // Otherwise, report a 405: Method Not Allowed error.
    throw httpError(
      405,
      `Can only perform a ${operationAST.operation} operation from a POST request.`,
      { headers: { Allow: "POST" } }
    );
  }
}
```

ç„¶åå°±æ˜¯æœ€æœ€æœ€é‡è¦çš„æ‰§è¡Œéƒ¨åˆ†äº†ï¼Œè¿™é‡Œçš„ä»£ç åè€Œå¾ˆå°‘ï¼Œå› ä¸ºè¦ä¹ˆæ‰§è¡ŒæˆåŠŸæ‹¿åˆ°ç»“æœï¼Œè¦ä¹ˆæ‰§è¡Œå¤±è´¥æŠ¥é”™å°±å®Œäº‹äº†

ç±»ä¼¼çš„ï¼Œ`extension`å¤„ç†èµ·æ¥ä¹Ÿå¾ˆç®€å•ã€‚

```typescript
try {
  result = await executeFn({
    schema,
    document: documentAST,
    rootValue,
    contextValue: context,
    variableValues: variables,
    operationName,
    fieldResolver,
    typeResolver,
  });
} catch (contextError) {
  throw httpError(400, "GraphQL execution context error.", {
    graphqlErrors: [contextError],
  });
}

if (extensionsFn) {
  const extensions = await extensionsFn({
    document: documentAST,
    variables,
    operationName,
    result,
    context,
  });

  if (extensions != null) {
    result = { ...result, extensions };
  }
}
```

ç„¶ååé¢ä¸»è¦å°±æ˜¯é”™è¯¯å¤„ç†äº†ï¼Œæœ‰å‡ ä¸ªåœ°æ–¹è¿˜æ˜¯éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š

```typescript
// ç©ºæ•°æ®è¡¨ç¤ºè¿è¡Œæ—¶æŸ¥è¯¢é”™è¯¯
if (response.statusCode === 200 && result.data == null) {
  response.statusCode = 500;
}

// è¯·æ±‚ä¸­å¯èƒ½å¸¦ç€é”™è¯¯ï¼Œæ¯”å¦‚éƒ¨åˆ†å­—æ®µæŸ¥è¯¢é”™è¯¯
const formattedResult: FormattedExecutionResult = {
  ...result,
  errors: result.errors?.map(formatErrorFn),
};

// åœ¨èƒ½æ˜¾ç¤ºGraphiQLæ—¶é€šè¿‡å…¶è¿”å›
if (showGraphiQL) {
  return respondWithGraphiQL(
    response,
    graphiqlOptions,
    params,
    formattedResult
  );
}
```

ç„¶åå°±å¯ä»¥è¿”å›è¯·æ±‚äº†:

```typescript
if (!pretty && typeof response.json === "function") {
  response.json(formattedResult);
} else {
  const payload = JSON.stringify(formattedResult, null, pretty ? 2 : 0);
  sendResponse(response, "application/json", payload);
}

function sendResponse(response: Response, type: string, data: string): void {
  const chunk = Buffer.from(data, "utf8");
  response.setHeader("Content-Type", type + "; charset=utf-8");
  response.setHeader("Content-Length", String(chunk.length));
  response.end(chunk);
}
```

ç„¶åå°± done~

#### GraphiQL

è¿™ä¸ªç¡®å®ç‰›çš®ï¼Œæ¯”å¦‚`loadFileStaticallyFromNPM`è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿”å›çš„æ¨¡æ¿å­—ç¬¦ä¸²é‡Œé¢ç›´æ¥æ‰§è¡Œï¼š

æ ¸å¿ƒè¿˜æ˜¯æ¥è‡ªäº`graphiql`è¿™ä¸ªåŒ…ï¼Œæˆ‘è¿˜ä»¥ä¸ºæ˜¯å†™åœ¨é‡Œé¢çš„...

```typescript
export function renderGraphiQL(
  data: GraphiQLData,
  options?: GraphiQLOptions,
): string {
  // ...
  return `
<!DOCTYPE html>
<html>
<head>
  <style>
    /* graphiql/graphiql.css */
    ${loadFileStaticallyFromNPM('graphiql/graphiql.css')}
  </style>
  <script>
    // promise-polyfill/dist/polyfill.min.js
    ${loadFileStaticallyFromNPM('promise-polyfill/dist/polyfill.min.js')}
  </script>
  <script>
    // unfetch/dist/unfetch.umd.js
    ${loadFileStaticallyFromNPM('unfetch/dist/unfetch.umd.js')}
  </script>
  <script>
    // react/umd/react.production.min.js
    ${loadFileStaticallyFromNPM('react/umd/react.production.min.js')}
  </script>
  <script>
    // react-dom/umd/react-dom.production.min.js
    ${loadFileStaticallyFromNPM('react-dom/umd/react-dom.production.min.js')}
  </script>
  <script>
    // graphiql/graphiql.min.js
    ${loadFileStaticallyFromNPM('graphiql/graphiql.min.js')}
  </script>
</head>`

```

ç„¶ååœ¨è¿™ä¹‹é—´å…¶å®è¿˜è¿›è¡Œäº†ä¸€äº›é€»è¾‘ï¼š

```typescript
// data ä¾›æ¸²æŸ“çš„æ•°æ®
const queryString = data.query;
// è¿™é‡Œçš„å˜é‡ä¸ç»“æœæ˜¯ç”¨äºå‘ˆç°çš„
const variablesString =
  data.variables != null ? JSON.stringify(data.variables, null, 2) : null;
const resultString =
  data.result != null ? JSON.stringify(data.result, null, 2) : null;
const operationName = data.operationName;
const defaultQuery = options?.defaultQuery;
const headerEditorEnabled = options?.headerEditorEnabled;
```

è¿”å›çš„ html ä¸­å®é™…ä¸ŠåŒ…æ‹¬äº† JSï¼š

```js
    var parameters = {};

    // å¤„ç†URLä¸­çš„å‚æ•°ï¼Œæ¯”å¦‚åœ¨IQLåŠ è½½æ—¶URLå°±å¸¦ç€queryå‚æ•°çš„
    window.location.search.substr(1).split('&').forEach(function (entry) {
      var eq = entry.indexOf('=');
      if (eq >= 0) {
        parameters[decodeURIComponent(entry.slice(0, eq))] =
          decodeURIComponent(entry.slice(eq + 1));
      }
    });

    // ç»„è£…æˆä¸€æ¬¡æœ¬åœ°æŸ¥è¯¢
    function locationQuery(params) {
      return '?' + Object.keys(params).filter(function (key) {
        return Boolean(params[key]);
      }).map(function (key) {
        return encodeURIComponent(key) + '=' +
          encodeURIComponent(params[key]);
      }).join('&');
    }


    var graphqlParamNames = {
      query: true,
      variables: true,
      operationName: true
    };

    var otherParams = {};
    for (var k in parameters) {
      if (parameters.hasOwnProperty(k) && graphqlParamNames[k] !== true) {
        otherParams[k] = parameters[k];
      }
    }
    var fetchURL = locationQuery(otherParams);


    // è´Ÿè´£è·å–æ•°æ®çš„å‡½æ•°
    function graphQLFetcher(graphQLParams, opts) {
      return fetch(fetchURL, {
        method: 'post',
        headers: Object.assign(
          {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          opts && opts.headers,
        ),
        body: JSON.stringify(graphQLParams),
        credentials: 'include',
      }).then(function (response) {
        return response.json();
      });
    }

    function onEditQuery(newQuery) {
      parameters.query = newQuery;
      updateURL();
    }

    function onEditVariables(newVariables) {
      parameters.variables = newVariables;
      updateURL();
    }

    function onEditOperationName(newOperationName) {
      parameters.operationName = newOperationName;
      updateURL();
    }

    function updateURL() {
      history.replaceState(null, null, locationQuery(parameters));
    }

    // æ¸²æŸ“GraphiQLç»„ä»¶ å¥½å®¶ä¼™ï¼
    ReactDOM.render(
      React.createElement(GraphiQL, {
        fetcher: graphQLFetcher,
        onEditQuery: onEditQuery,
        onEditVariables: onEditVariables,
        onEditOperationName: onEditOperationName,
        query: ${safeSerialize(queryString)},
        response: ${safeSerialize(resultString)},
        variables: ${safeSerialize(variablesString)},
        operationName: ${safeSerialize(operationName)},
        defaultQuery: ${safeSerialize(defaultQuery)},
        headerEditorEnabled: ${safeSerialize(headerEditorEnabled)},
      }),
      document.getElementById('graphiql')
    );
```
